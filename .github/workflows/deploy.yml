name: Deploy TALL Stack to Hetzner

on:
  push:
    branches: [main]
    paths:
      - 'tall-stack/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    uses: NickHeymann/shared-workflows/.github/workflows/deploy-hetzner.yml@main
    with:
      image-name: nickheymann/xn--musikfrfirmen-1ob.de-tall
      deploy-path: /opt/apps/xn--musikfrfirmen-1ob.de-tall
      docker-context: ./tall-stack
      concurrency-group: deploy-production
      post-deploy-commands: |
        docker compose exec -T app php artisan migrate --force
        docker compose exec -T app php artisan config:cache
        docker compose exec -T app php artisan route:cache
        docker compose exec -T app php artisan view:cache
        docker compose exec -T app php artisan queue:restart
        docker compose ps queue --format "table {{.Name}}\t{{.Status}}"
    secrets: inherit
